extends ../no-cache-sub-relayout.pug
include functions.pug

block append vars
  -
    let options = {company:"Team"}
    const getPlayerCasualtyIcon = function(cas){
      switch(Number(cas)){ 
        case 1: return ["ico_action_badly_hurt.png",""]
        case 2: return ["ico_action_seriously_hurt.png","MNG"]
        case 3: return ["ico_action_serious_injury.png","+1 on injury rolls"]
        case 4: return ["ico_action_lasting_injury.png",""]
        case 5: return ["ico_action_smashed_knee.png","-1 MV"]
        case 6: return ["ico_action_head_injury.png","-1 AV"]
        case 7: return ["ico_action_broken_arm.png","+1 PA"]
        case 8: return ["ico_action_neck_injury.png","+1 AG"]
        case 9: return ["ico_action_dislocated_shoulder.png","-1 ST"]
        case 10: return "ico_action_dead.png";
      }
      return false;
    }
block head 
  style.
    .col-12 table img {width: 40px;height: 40px;}
    .silhouette-shadow{
      filter: drop-shadow(0px 0px 1px black);
    }

block content
  div(class="container")
    div(class="col-12 d-flex flex-wrap align-items-center")
      img(src=`https://cdn.rebbl.net/images/bb3/Logos/${team.logo.icon}` class="align-top" style="height:100px")
      span(class="h1")=team.name
      div(class="row col-12")
        h3(style="margin-top: 0px;")
          i= team.motto
    div(class="clearfix")
    div(class="row" style="margin-left:0px")
      div(class="col-md-2 col-6")
        strong=`Current TV: ${team.value/1000}`
      div(class="col-md-2 col-6")
        strong=`Cash: ${team.treasury}`
    div(class="row" style="margin-left:0px")
      div(class="col-md-1 col-6")
        img(src="https://cdn.rebbl.net/images/bb3/dedicated_fan.png")
        strong=team.improvements[3].quantity
      div(class="col-md-1 col-6")
        img(src="https://cdn.rebbl.net/images/bb3/reroll.png")
        strong=team.improvements[4].quantity
      div(class="col-md-1 col-6")
        img(src="https://cdn.rebbl.net/images/bb3/cheerleader.png")
        strong=team.improvements[1].quantity
      div(class="col-md-1 col-6")
        img(src="https://cdn.rebbl.net/images/bb3/assistant_coach.png")
        strong=team.improvements[2].quantity
      - if (team.improvements[0].quantity > 0)
        div(class="col-md-1 col-6")
          img(src="https://cdn.rebbl.net/images/bb3/apo.png")

    //div(class="row" style="margin-left:0px")
      div(class="col-12 table-responsive-md")
        table(class="table table-striped") 
          thead(class="headerText")
            tr 
              th
              th(class="d-none d-md-table-cell") tackles
              th(class="d-md-none") Tckl
              th(class="d-none d-md-table-cell") injuries
              th(class="d-md-none") Inj
              th stuns
              th ko
              th CAS
              th dead
              th(class="d-none d-md-table-cell") running (m)
              th(class="d-md-none") Run (m)
              th(class="d-none d-md-table-cell") passing (m)
              th(class="d-md-none") Pas (m)
              th(class="d-none d-md-table-cell") passes
              th(class="d-md-none") Pas
              th(class="d-none d-md-table-cell") interc.
              th(class="d-md-none") Int
              th(class="d-none d-md-table-cell") touchdowns
              th(class="d-md-none") TDs
              th surfs
          tbody
            tr
              td inflicted
              td=getStat(team.statistics, 26)
              td=getStat(team.statistics, 22)
              td - 
              td=getStat(team.statistics, 25)
              td=getStat(team.statistics, 19)
              td=getStat(team.statistics, 21)
              td=getStat(team.statistics, 23)
              td=getStat(team.statistics, 24)
              td=getStat(team.statistics, 41)
              td=getStat(team.statistics, 55)
              td=getStat(team.statistics, 18)
              td=getStat(team.statistics, 57)
            tr  
              td sustained
              td=getStat(team.statistics, 59)
              td=getStat(team.statistics, 30)
              td - 
              td=getStat(team.statistics, 29)
              td=getStat(team.statistics, 28)
              td=getStat(team.statistics, 31)
              td -
              td -
              td -
              td=getStat(team.statistics, 58)
              td=getStat(team.statistics, 27)
              td -

    br
    nav(class="col-12")
      div(class="nav nav-tabs" id="nav-tab" role="tablist")
        a(class="nav-item nav-link active" id="nav-home-tab" data-bs-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true") Players
        a(class="nav-item nav-link" id="nav-matches-tab" data-bs-toggle="tab" href="#nav-matches" role="tab" aria-controls="nav-matches" aria-selected="false" data-bind="click:selectMatches") Matches
    div(class="tab-content" id="tabContent")
      div(class="tab-pane fade col-12 show active table-responsive-md" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab")
        table(class="table table-striped")
            thead(class="headerText")
              tr
                th(scope="col") #
                th(scope="col") name
                th(scope="col") position
                th(scope="col") MA
                th(scope="col") ST
                th(scope="col") AG
                th(scope="col") PA
                th(scope="col") AV
                th(scope="col" style="min-width:160px") Skills
                th(scope="col") CAS
                th(scope="col") SPP
                th(scope="col") Value
            tbody
              - for(let player of team.roster)
                tr(class=Number(player.player.missNextGame)==1?"player-out":"player-in") 
                  td=player.player.number
                  td
                    div
                      img(src=`https://cdn.rebbl.net/images/skills/${player.player.level}.png` alt="", class="TeamLabel-logo" style="width:30px;margin-right:2px;height:30px;float:left;")
                      .match-stats-TeamLabel-name=player.player.name
                  td
                    - let p = getPosition(player.player.position)
                    img.silhouette-shadow(src=getSilhouette(player.player.position) title=p)
                  - let c = player.player.characteristics.playerCharacteristicsEntry.find(x=>x.characteristic==0)
                  td= c ? c.value : "-"
                  - c = player.player.characteristics.playerCharacteristicsEntry.find(x=>x.characteristic==1)
                  td= c ? c.value : "-"
                  - c = player.player.characteristics.playerCharacteristicsEntry.find(x=>x.characteristic==2)
                  td= c ? c.value : "-"
                  - c = player.player.characteristics.playerCharacteristicsEntry.find(x=>x.characteristic==3)
                  td= c ? c.value : "-"
                  - c = player.player.characteristics.playerCharacteristicsEntry.find(x=>x.characteristic==4)
                  td= c ? c.value : "-"
                  td(class="td-prevent")
                    - for(let skill of Array.isArray(player.player.skills.skillsItem) ? player.player.skills.skillsItem : [player.player.skills.skillsItem] )
                      - let s = skills.find(x => x.id == skill)
                      - if (s)
                        img(src=`https://cdn.rebbl.net/images/skills/${user && user.icon ? user.icon : "BB3Standard"}/${s.icon}` title=s.name.replace(/([A-Z])/g, ' $1').trim() alt="" style="z-index:9999" )
                  td.pull-right
                    each cas in Array.isArray(player.player.casualties.casualtiesItem) ? player.player.casualties.casualtiesItem:[player.player.casualties.casualtiesItem]
                      -let d = getPlayerCasualtyIcon(cas)
                      if d
                        img(src=`https://cdn.rebbl.net/images/bb3/Icons_Casualty/${d[0]}` title=d[1])
                    if player.player.missNextGame == "1"
                        img(src=`https://cdn.rebbl.net/images/bb3/Icons_Casualty/ico_action_recovering.png`)
                    if retiredPlayers.some(x => x.id === player.player.id)
                      span.badge.text-bg-success.ms-2 retired    
                    if user && user.bb3id === team.coachId && team.allowRetire && team.allowRetire.some(x => x === player.player.id)
                      button.btn.btn-sm.btn-success.ms-2(type="button" onclick=`showModal("${player.player.id}","${player.player.name}")`) TR
                   
                  td=player.player.spp
                  td(data-bind="text:value")=player.player.value
      .tab-pane.fade.col-12.show.table-responsive-md(id="nav-matches" role="tabpanel" aria-labelledby="nav-matches-tab")
        each match of matches.reverse()
          include matchOverview
 
  #playerModal.modal.fade(data-bs-backdrop="static"  data-bs-keyboard="false" tabindex="-1" aria-labelledby="playerModal" aria-hidden="true")
    .modal-dialog.modal-xl
      .modal-content 
        .modal-header 
          h1.modal-title#titleName Temporarily Retire
          button.btn-close(type="button"  data-bs-dismiss="modal" aria-label="Close")
        .modal-body 
          .modal-page
            h3  Season implications

            p You are about to temporarily retire a player, this has some implications.
            p First off, the player will remain on your roster, but will have the Miss Next Game state for the remainder of the season.
            p If you at later stage change your mind, the only option you have is to fire the player.
          .modal-page 
            h3 Redraft 

            p Once the season is over, after playoffs if you make it to the playoffs, you can decide if you want draft the player for the next season.
            p If you decide to do so, an attempt to cure the player will be made. A  D6 will be rolled for each Injury that is a stats bust. If you have an Apothecary rostered, you'll receive a +1 on the dice roll. 
            p On a roll of 4+, the injury will be turned into a Serious Injury (niggle).
            .p-3.text-bg-info.border-start.border-2.border-info-subtle Drafting a temporarily retired player and curing them is a commitment you can't regret, you have to roster the player once the decision is made and the dice are rolled.
          .modal-page 
            h3#titleConfirm Confirmation

            p#character

            p#proceed If you confirm and click proceed
            .form-check.form-switch
              input#consent.form-check-input(type="checkbox" role="switch")
              label.form-check-label(for="consent") I have read and understand what I'm getting myself into.
            
        .modal-footer(style="justify-content: space-between") 
          button#btnCancel.btn.btn-primary(type="button" data-bs-dismiss="modal") Cancel
          button#btnBack.btn.btn-primary.d-none(type="button" onclick="handleBack()") Back
          button#btnNext.btn.btn-primary(type="button" onclick="handleNext()") Next
          button#btnProceed.btn.btn-success.d-none(type="button" onclick="handleProceed()" disabled) Proceed
            #spinner.d-none.spinner-grow.spinner-grow-sm.ms-2(role="status")

  .toast-container.top-0.start-50
    #successToast.toast.align-items-center.text-bg-success.border-0(role="alert" aria-live="assertive" aria-atomic="true")
      .d-flex
        .toast-body
          | Player has been successfully retired.
        button.btn-close.btn-close-white.me-2.m-auto( type="button" data-bs-dismiss="toast" aria-label="Close")

    #errorToast.toast.align-items-center.text-bg-danger.border-0(role="alert" aria-live="assertive" aria-atomic="true")
      .d-flex
        .toast-body
          | Something went wrong, please contact the admins.
        button.btn-close.btn-close-white.me-2.m-auto( type="button" data-bs-dismiss="toast" aria-label="Close")


block scripts 
  script.
    const playerModal = new bootstrap.Modal(document.getElementById('playerModal'), {});  
    let playerId;
    let pages;
    let page_track = 0;

    $(document).ready(function() {
      prep_modal();
      $("#consent").on("change", handleConsentChange)
    });

    function handleConsentChange(e,v){
      const btnProceed = document.getElementById("btnProceed");

      if (e.target.checked) btnProceed.disabled = false;
      else btnProceed.disabled = true;
    }    

    function prep_modal()
    {
      $(".modal").each(function() {
        const element = this;
        pages = $(element).find('.modal-page');
        pages.hide();
        pages.eq(page_track).show();
      });
    }

    function handleBack() {
      const btnBack = document.getElementById("btnBack");
      const btnNext = document.getElementById("btnNext");
      const btnProceed = document.getElementById("btnProceed");

      if(page_track == 1) btnBack.classList.add("d-none");
      if(page_track < 1) return

      if(page_track == pages.length-1) {
        btnProceed.classList.add("d-none");
        btnNext.classList.remove("d-none");
      }


      page_track--;
      pages.hide();
      pages.eq(page_track).show();
    }

    function handleNext(){
      const btnBack = document.getElementById("btnBack");
      const btnNext = document.getElementById("btnNext");
      const btnProceed = document.getElementById("btnProceed");

      if(page_track == 0) btnBack.classList.remove("d-none");
      if(page_track == pages.length-2) {
        btnProceed.classList.remove("d-none");
        btnNext.classList.add("d-none");
      }

      if(page_track < pages.length-1)
      {
        page_track++;

        pages.hide();
        pages.eq(page_track).show();
      }
    }

    async function handleProceed(){
      const btnProceed = document.getElementById("btnProceed");
      const spinner = document.getElementById("spinner");
      btnProceed.disabled =  true;
      spinner.classList.remove("d-none");

      const response = await fetch(`/bb3/team/#{team.id}/retire/${playerId}`, {method:"POST"});

      if (response.ok){
        const e = document.getElementById("successToast");
        const toast = new bootstrap.Toast(e);
        toast.show();
      } else {
        const e = document.getElementById("errorToast");
        const toast = new bootstrap.Toast(e);
        toast.show();
      }

      spinner.classList.add("d-none");

      playerModal.hide();
    }

    function showModal(id, name){
      $("#consent")[0].checked = false;
      $("#btnProceed")[0].disabled = true; 


      btnProceed.classList.add("d-none");
      btnNext.classList.remove("d-none");


      playerId = id;
      page_track = 0;

      let elm = document.getElementById("titleName");
      elm.innerHTML = `temporarily retiring ${name}`;

      elm = document.getElementById("proceed");
      elm.innerHTML = `If you confirm and click proceed, ${name} will be temporarily retired.`;

      playerModal.show();
    }